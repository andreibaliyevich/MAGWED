<script setup>
import axios from 'axios'
import 'cropperjs/dist/cropper.css'
import Cropper from 'cropperjs'
import { ref, watch, onMounted } from 'vue'

const coverLoading = ref(true)
const coverProcessing = ref(false)
const coverReady = ref(false)
const cover = ref(null)
const coverUpdateDialog = ref(false)
const coverRemoveDialog = ref(false)
const coverImg = ref(null)
const coverCropper = ref(null)

const status = ref(null)
const errors = ref(null)

const getCover = async () => {
  try {
    const response = await axios.get('/accounts/auth/cover/')
    cover.value = response.data.cover
  } catch (error) {
    status.value = null
    errors.value = error.response.data
  } finally {
    coverLoading.value = false
  }
}

const loadCoverImg = async (filelist) => {
  coverUpdateDialog.value = true
  const reader = new FileReader()
  reader.readAsDataURL(filelist[0])
  reader.onload = () => {
    coverImg.value.src = reader.result
    coverImg.value.alt = filelist[0].name
    coverReady.value = true
  }
}

const updateCover = async (filelist) => {
  coverProcessing.value = true

  const croppedCanvas = coverCropper.value.getCroppedCanvas({
    width: 1500,
    height: 500
  })
  const canvasBlob = await new Promise((resolve) => {
    croppedCanvas.toBlob((blob) => {
      resolve(blob)
    })
  })

  let formData = new FormData()
  formData.append('cover', canvasBlob, coverImg.value.alt)

  try {
    const response = await axios.put('/accounts/auth/cover/', formData)
    cover.value = response.data.cover
    status.value = response.status
    errors.value = null
  } catch (error) {
    status.value = null
    errors.value = error.response.data
  } finally {
    coverProcessing.value = false
    coverUpdateDialog.value = false
  }
}

const removeCover = async () => {
  coverProcessing.value = true
  try {
    const response = await axios.delete('/accounts/auth/cover/')
    cover.value = null
    status.value = response.status
    errors.value = null
  } catch (error) {
    status.value = null
    errors.value = error.response.data
  } finally {
    coverProcessing.value = false
    coverRemoveDialog.value = false
  }
}

watch(coverReady, (newValue) => {
  if (newValue) {
    coverCropper.value = new Cropper(coverImg.value, {
      viewMode: 1,
      dragMode: 'crop',
      aspectRatio: 3 / 1,
      zoomable: false
    })
  }
})

watch(coverUpdateDialog, (newValue) => {
  if (!newValue && coverReady) {
    coverCropper.value.destroy()
    coverCropper.value = null
    coverImg.value.src = ''
    coverImg.value.alt = ''
    coverReady.value = false
  }
})

onMounted(() => {
  getCover()
})
</script>

<template>
  <v-card class=my-5>
    <div
      v-if="coverLoading"
      class="d-flex justify-center align-center my-10"
    >
      <v-progress-circular indeterminate></v-progress-circular>
      &nbsp;
      {{ $t('user.loading_cover') }}
    </div>
    <div
      v-else
      class="text-center"
    >
      <v-img
        :src="cover ? cover : '/cover.jpg'"
        aspect-ratio="3/1"
      ></v-img>

      <small
        v-if="status === 200"
        class="text-success"
      >
        {{ $t('user.cover_updated_successfully') }}
      </small>
      <small
        v-else-if="status === 204"
        class="text-success"
      >
        {{ $t('user.cover_removed_successfully') }}
      </small>
      <div
        v-if="errors?.cover"
        class="text-danger"
      >
        <small v-for="error in errors.cover">
          {{ error }}
        </small>
      </div>

      <div class="d-flex justify-space-evenly py-1">
        <FileInputButton
          @selectedFiles="loadCoverImg"
          accept="image/*"
          variant="flat"
          color="primary"
          class="text-none"
        >
          {{ $t('user.update_cover') }}
        </FileInputButton>
        <v-btn
          @click="coverRemoveDialog = true"
          :disabled="!cover"
          variant="outlined"
          class="text-none"
        >
          {{ $t('user.remove_cover') }}
        </v-btn>
      </div>

      <small class="text-grey-darken-1">
        {{ $t('form_help.input_img', { width: '1500', height: '500' }) }}
      </small>

      <v-dialog
        v-model="coverUpdateDialog"
        width="auto"
        persistent
      >
        <v-card>
          <div class="d-flex justify-center align-center">
            <v-icon
              v-if="!coverReady"
              icon="mdi-image-area"
              role="img"
              color="secondary"
              :size="150"
            ></v-icon>
            <img
              ref="coverImg"
              src=""
              alt=""
              class="mw-100 max-vh-75"
            >
          </div>
          <v-card-actions>
            <v-spacer></v-spacer>
            <v-btn
              @click="coverUpdateDialog = false"
              class="text-none"
            >
              {{ $t('btn.cancel') }}
            </v-btn>
            <v-btn
              @click="updateCover()"
              :loading="coverProcessing"
              :disabled="!coverReady"
              variant="flat"
              color="primary"
              class="text-none"
            >
              {{ $t('btn.update') }}
            </v-btn>
          </v-card-actions>
        </v-card>
      </v-dialog>

      <v-dialog
        v-model="coverRemoveDialog"
        width="auto"
        persistent
      >
        <v-card>
          <v-card-title>
            {{ $t('user.you_want_remove_cover') }}
          </v-card-title>
          <v-card-text>
            {{ $t('user.cover_will_be_set_default') }}
          </v-card-text>
          <v-card-actions>
            <v-spacer></v-spacer>
            <v-btn @click="coverRemoveDialog = false">
              {{ $t('btn.no_cancel') }}
            </v-btn>
            <v-btn
              @click="removeCover()"
              :loading="coverProcessing"
            >
              <strong>{{ $t('btn.yes_i_am_sure') }}</strong>
            </v-btn>
          </v-card-actions>
        </v-card>
      </v-dialog>
    </div>
  </v-card>
</template>
